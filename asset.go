package main

import (
	"Polybot/polymarket"
	"log"
	"sync"
)

type assetTradeEvent struct {
	polymarket.Trade
	EventType string `json:"event_type"`
}

func InitAssets(client *PolymarketClient) {
	var wg sync.WaitGroup
	funder := client.Me()

	for _, marketID := range GetActiveMarketIDs() {
		wg.Add(1)
		go func(market string) {
			defer wg.Done()
			resp, err := client.GetClient().GetTradesTyped(map[string]string{"market": market})
			if err != nil {
				log.Printf("init assets: get trades failed for %s: %v", market, err)
				return
			}
			applyTradesToInventory(resp.Data, funder)
		}(marketID)
	}

	wg.Wait()
}

/*
UpdateAsset
{"type":"TRADE", "id":"5b1d0460-876d-4cc0-aeb4-32bbd00fe4e5", "taker_order_id":"0xcb23b1b42746ea381d85d026a670d0f4219e5af51cba6d06dc14751085a119c2", "market":"0x0936baff284871821b1ab5c64d33d67f117392dba34d461fe04360df893dfde4", "asset_id":"20168250870314270898487593595943592687458358996170785976290704639743788087191", "side":"BUY", "size":"16.230768", "fee_rate_bps":"0", "price":"0.13", "status":"MATCHED", "match_time":"1766481859", "last_update":"1766481859", "outcome":"Up", "owner":"db18890d-c1a0-19a2-4269-5f2d6cfe2321", "trade_owner":"db18890d-c1a0-19a2-4269-5f2d6cfe2321", "maker_address":"0xf444220e8d32f456c39B6B727e7Bb5Bc41D8C970", "transaction_hash":"0x4770a1e71a3333cce1ab6d0fb8d0d57c1ae9f2a50f937f7261422db21fc72a39", "bucket_index":0, "maker_orders":[{"order_id":"0x72fd5dc5fa084f7f3823befdcf39a7b2a5ea1893774a718cfc51332481c2b4fb", "owner":"38b1f780-92a6-ebaa-4116-f082ecd29f20", "maker_address":"0x462C59a23186c0aCD5F1eD4fC816e5e91d4Abea1", "matched_amount":"8", "price":"0.87", "fee_rate_bps":"0", "asset_id":"25245433628208476987364023432306599125597948324625578977436890641930158259698", "outcome":"Down", "outcome_index":0, "side":"BUY"}, {"order_id":"0x2513f64444329215271bcc9e62d62f4bd86f130ead330e2343236c458f55b26e", "owner":"c65e3cc5-bafb-7fd6-9fa0-f69c09e4e4e0", "maker_address":"0x9d5b56830bC15f2fF54EE559a9026838fE5EE52F", "matched_amount":"5", "price":"0.87", "fee_rate_bps":"0", "asset_id":"25245433628208476987364023432306599125597948324625578977436890641930158259698", "outcome":"Down", "outcome_index":0, "side":"BUY"}, {"order_id":"0x5cce1af9146a5cb0bfe3bd2aee2cbd79653338019bcb5b15e3f98fd93a1502bf", "owner":"a35aea61-d3e2-77b0-ba53-3c4dd029291c", "maker_address":"0x795c3aAA5fd42EA3b3543A8F6958F0bC8b4F8171", "matched_amount":"3.230768", "price":"0.870000260000099", "fee_rate_bps":"0", "asset_id":"25245433628208476987364023432306599125597948324625578977436890641930158259698", "outcome":"Down", "outcome_index":0, "side":"BUY"}], "trader_side":"MAKER", "timestamp":"1766481859679", "event_type":"trade"}
*/
func UpdateAsset(msg []byte, funder string) []string {
	if len(msg) == 0 {
		return nil
	}
	var event assetTradeEvent
	if err := decodeJSON(msg, &event); err != nil {
		return nil
	}
	return applyAssetTradeEvent(event, funder)
}

func applyAssetTradeEvent(msg assetTradeEvent, funder string) []string {
	if msg.EventType != "trade" {
		return nil
	}
	if msg.Status != "MATCHED" {
		return nil
	}

	return applyTradeForInventory(
		msg.AssetID,
		msg.Market,
		msg.Side,
		msg.TraderSide,
		msg.MakerAddress,
		msg.Price,
		msg.Size,
		msg.MakerOrders,
		funder,
		"inventory update",
	)
}

/*
{"data":[{"id":"277f14b1-c5cd-4d00-8173-8dd812c21f76","taker_order_id":"0x46e49c8e1c4cf051262f25c984b0862f55ccbc38b406bb62407b506f3d19addf","market":"0x68f79b97fa41416161cd43b51c95db15b00b56d981daff25e5edb73a9d0312b0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","side":"BUY","size":"25","fee_rate_bps":"0","price":"0.9","status":"CONFIRMED","match_time":"1766475900","last_update":"1766475963","outcome":"Down","bucket_index":0,"owner":"b3f40994-1202-a6b9-b35c-a2d2b67e8263","maker_address":"0x09fe78c8B9f10FB9C7c0a584BfAb4205C76876ee","transaction_hash":"0x3f19a59e283a4602fda077188408b3e6a4575697750f37d977e8c915adb5dae0","maker_orders":[{"order_id":"0x872498ca039a56c47cd5969f1344648fde294986c21f15b940df534d96eb97aa","owner":"a35aea61-d3e2-77b0-ba53-3c4dd029291c","maker_address":"0x795c3aAA5fd42EA3b3543A8F6958F0bC8b4F8171","matched_amount":"25","price":"0.9","fee_rate_bps":"0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","outcome":"Down","side":"SELL"}],"trader_side":"MAKER"},{"id":"e194dfdf-6a4b-48bd-b884-13e5f0cce442","taker_order_id":"0x23b65f910774a577dd7d7a91ce6b99ad07cc0b2509f3e73086e261b5cbf037d3","market":"0x68f79b97fa41416161cd43b51c95db15b00b56d981daff25e5edb73a9d0312b0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","side":"BUY","size":"64.99","fee_rate_bps":"0","price":"0.9","status":"CONFIRMED","match_time":"1766475900","last_update":"1766475963","outcome":"Down","bucket_index":0,"owner":"7c177f20-a089-afa1-1621-5eee39b5ce1b","maker_address":"0x961AFCE6Bd9aEC79C5cF09D2D4dac2b434b23361","transaction_hash":"0x7b75c04de710e17d0e0cb0917d2d2c6d7f1c8f7dd1e121afffa57b61616a7152","maker_orders":[{"order_id":"0x872498ca039a56c47cd5969f1344648fde294986c21f15b940df534d96eb97aa","owner":"a35aea61-d3e2-77b0-ba53-3c4dd029291c","maker_address":"0x795c3aAA5fd42EA3b3543A8F6958F0bC8b4F8171","matched_amount":"64.99","price":"0.9","fee_rate_bps":"0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","outcome":"Down","side":"SELL"}],"trader_side":"MAKER"},{"id":"1d66ba47-a43f-4b46-a8f8-c6d37f8367f3","taker_order_id":"0x9d67f8b8f35684d569aaff27f2a9b65b2a7ab3604341001fa2e0f9e3267f72e7","market":"0x68f79b97fa41416161cd43b51c95db15b00b56d981daff25e5edb73a9d0312b0","asset_id":"51580329578054957149489759798488692655735024964083433749651796523214592637969","side":"SELL","size":"40.07","fee_rate_bps":"0","price":"0.38","status":"CONFIRMED","match_time":"1766475608","last_update":"1766475643","outcome":"Up","bucket_index":0,"owner":"a35aea61-d3e2-77b0-ba53-3c4dd029291c","maker_address":"0x795c3aAA5fd42EA3b3543A8F6958F0bC8b4F8171","transaction_hash":"0xbca325db6092cae8d0c224a224625b394afaa60bd3acde2d2202325f9a44c8ec","maker_orders":[{"order_id":"0x202bdaa89c930eaa22a8a0904e4cb2b018036cfc0d1424d4e7bac1ac0dd5b5dd","owner":"e4bf1fa7-2148-f896-5363-a813fe8f76fe","maker_address":"0x86a29F88fcc23Ea2B0e01B4e186b043E26c873A8","matched_amount":"40.07","price":"0.38","fee_rate_bps":"0","asset_id":"51580329578054957149489759798488692655735024964083433749651796523214592637969","outcome":"Up","side":"BUY"}],"trader_side":"TAKER"},{"id":"dead3608-5622-4cff-9fbc-05181be7e6c2","taker_order_id":"0x68e6d4915bb43909cd1788a13a6f9c21a34507d35fc9dac733aac5839bf63345","market":"0x68f79b97fa41416161cd43b51c95db15b00b56d981daff25e5edb73a9d0312b0","asset_id":"51580329578054957149489759798488692655735024964083433749651796523214592637969","side":"BUY","size":"51.910445","fee_rate_bps":"0","price":"0.67","status":"CONFIRMED","match_time":"1766475096","last_update":"1766475131","outcome":"Up","bucket_index":0,"owner":"db18890d-c1a0-19a2-4269-5f2d6cfe2321","maker_address":"0xf444220e8d32f456c39B6B727e7Bb5Bc41D8C970","transaction_hash":"0xf2eec59ad6a99565cb84424db73675bccac911d13a353061b2d32ccb2c1af89a","maker_orders":[{"order_id":"0x88247a7ce5a0e9d8f822dde43007dc6e8d9cdc41334d938cab09fd32f26ee30a","owner":"a58b5d1b-fa26-c1be-b2ab-2586c0429570","maker_address":"0x9272EfC25eDD7Baafb7896caf2F32042133125b5","matched_amount":"39.94","price":"0.33","fee_rate_bps":"0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","outcome":"Down","side":"BUY"},{"order_id":"0x6604649b2bd58ef1bed6fbcfe1e3048fdd013cce34a9dab2c6865829a2b05058","owner":"a35aea61-d3e2-77b0-ba53-3c4dd029291c","maker_address":"0x795c3aAA5fd42EA3b3543A8F6958F0bC8b4F8171","matched_amount":"10","price":"0.33","fee_rate_bps":"0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","outcome":"Down","side":"BUY"},{"order_id":"0xca2dc448d421a31f9b6925ce6cd3d89373c9805d4fa1952ef47cfb0966d4ceb6","owner":"6b825e66-25c3-fdc6-60eb-c34394eb9057","maker_address":"0x4b41cAe759ef7a9E09266022580B2f9eBD7985F8","matched_amount":"1.970445","price":"0.3300000761249362","fee_rate_bps":"0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","outcome":"Down","side":"BUY"}],"trader_side":"MAKER"},{"id":"127d142a-2829-4cc8-ac84-d69afb857861","taker_order_id":"0xa9e2d6d6a675bce19cbcc85d623994c6b22188db8015901e68b4fa49b896a671","market":"0x68f79b97fa41416161cd43b51c95db15b00b56d981daff25e5edb73a9d0312b0","asset_id":"51580329578054957149489759798488692655735024964083433749651796523214592637969","side":"BUY","size":"2.42","fee_rate_bps":"0","price":"0.66","status":"CONFIRMED","match_time":"1766475077","last_update":"1766475131","outcome":"Up","bucket_index":0,"owner":"e4bf1fa7-2148-f896-5363-a813fe8f76fe","maker_address":"0x86a29F88fcc23Ea2B0e01B4e186b043E26c873A8","transaction_hash":"0x2beea65c9774ff2d2563d6bd8ceb008dff9cee97edf42ee1c3d70d64ceb61b7d","maker_orders":[{"order_id":"0x5381a791c883c7068db19e4895eb728a3d753cb9ab8d694e0b8be85ecd70d517","owner":"a35aea61-d3e2-77b0-ba53-3c4dd029291c","maker_address":"0x795c3aAA5fd42EA3b3543A8F6958F0bC8b4F8171","matched_amount":"2.42","price":"0.34","fee_rate_bps":"0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","outcome":"Down","side":"BUY"}],"trader_side":"MAKER"},{"id":"1ba611d9-68f2-42a3-9cf0-10ffd291aaaf","taker_order_id":"0xb465c7464347b9e91134fbfc926945668fd6131e24106834ec874b96c0a36512","market":"0x68f79b97fa41416161cd43b51c95db15b00b56d981daff25e5edb73a9d0312b0","asset_id":"51580329578054957149489759798488692655735024964083433749651796523214592637969","side":"BUY","size":"7.575755","fee_rate_bps":"0","price":"0.66","status":"CONFIRMED","match_time":"1766475076","last_update":"1766475131","outcome":"Up","bucket_index":0,"owner":"6b825e66-25c3-fdc6-60eb-c34394eb9057","maker_address":"0x4b41cAe759ef7a9E09266022580B2f9eBD7985F8","transaction_hash":"0x490856adccacfd1e0870170a0a148678bbe11b20630214be587e67a10bd3f7ce","maker_orders":[{"order_id":"0x5381a791c883c7068db19e4895eb728a3d753cb9ab8d694e0b8be85ecd70d517","owner":"a35aea61-d3e2-77b0-ba53-3c4dd029291c","maker_address":"0x795c3aAA5fd42EA3b3543A8F6958F0bC8b4F8171","matched_amount":"7.575755","price":"0.3400000396000135","fee_rate_bps":"0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","outcome":"Down","side":"BUY"}],"trader_side":"MAKER"},{"id":"62501f2e-006e-4404-9966-9dcffadf214e","taker_order_id":"0x291c6c77e63305b8f2f6ea53414826c201f2e0543c3cac03ca6ca8d87d7b7c72","market":"0x68f79b97fa41416161cd43b51c95db15b00b56d981daff25e5edb73a9d0312b0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","side":"SELL","size":"22.82","fee_rate_bps":"0","price":"0.35","status":"CONFIRMED","match_time":"1766475075","last_update":"1766475131","outcome":"Down","bucket_index":0,"owner":"ddcdbec0-6736-b2f4-5713-0c1dec277959","maker_address":"0xfdB826A0fB4A90b4CC9049E408ea3Ef1B73Ae4c9","transaction_hash":"0x9fedaaeb9e0f27a616facfe401dc0e7b135f7516bb6a462f3000a8d978609a10","maker_orders":[{"order_id":"0xcf0e8f86350ba2eb631730087b0e88a9ce63282e72470f0a67b398c6d634f129","owner":"b51350f5-d602-a44c-2b7b-f4353d415fde","maker_address":"0x8bb3B2BF23D2B20DBba4aF37Ce3454c419DA688D","matched_amount":"5","price":"0.35","fee_rate_bps":"0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","outcome":"Down","side":"BUY"},{"order_id":"0x1d1d404f0d4fb342ce7d8d5b79569ad664cb1c46df28fa64c0287f9cdac72d03","owner":"6b825e66-25c3-fdc6-60eb-c34394eb9057","maker_address":"0x4b41cAe759ef7a9E09266022580B2f9eBD7985F8","matched_amount":"7.82","price":"0.35","fee_rate_bps":"0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","outcome":"Down","side":"BUY"},{"order_id":"0xb49b367d73944075282da4e2329e4794bb891add498aa8370f59487506f5bd9d","owner":"a35aea61-d3e2-77b0-ba53-3c4dd029291c","maker_address":"0x795c3aAA5fd42EA3b3543A8F6958F0bC8b4F8171","matched_amount":"10","price":"0.35","fee_rate_bps":"0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","outcome":"Down","side":"BUY"}],"trader_side":"MAKER"},{"id":"0b86bdfa-9436-4904-97c6-0d7ffaf8357b","taker_order_id":"0xcd43922994cf7c58052a1e1447c0e3fafef1349fa8e5a96b3619e72c28ac3300","market":"0x68f79b97fa41416161cd43b51c95db15b00b56d981daff25e5edb73a9d0312b0","asset_id":"51580329578054957149489759798488692655735024964083433749651796523214592637969","side":"BUY","size":"16","fee_rate_bps":"0","price":"0.64","status":"CONFIRMED","match_time":"1766475074","last_update":"1766475131","outcome":"Up","bucket_index":0,"owner":"d266bc1d-771c-3a13-5ae0-9a61f0880e6e","maker_address":"0x6031B6eed1C97e853c6e0F03Ad3ce3529351F96d","transaction_hash":"0x714a4e07e80de292bb456b40e81dd3677ab6f69660242db5920e19ccdc173274","maker_orders":[{"order_id":"0xbbdda4cfbf819c3c240849e43baf20108cf244b21ee4e6ce350ffaed780a8662","owner":"a35aea61-d3e2-77b0-ba53-3c4dd029291c","maker_address":"0x795c3aAA5fd42EA3b3543A8F6958F0bC8b4F8171","matched_amount":"10","price":"0.36","fee_rate_bps":"0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","outcome":"Down","side":"BUY"},{"order_id":"0x97d4ed5c8da852071b5d187f6c021c1d07f5954e9758b11a78723beba686cfac","owner":"0f1b9b28-ded2-5f91-febe-6325310e352d","maker_address":"0xdE4DDABc9e2e05E33eA0b10d358314191Be10f08","matched_amount":"6","price":"0.36","fee_rate_bps":"0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","outcome":"Down","side":"BUY"}],"trader_side":"MAKER"},{"id":"70af91b4-906a-4c74-a590-db471414ba85","taker_order_id":"0xb019cddb3eb480d77a2c0f00a31306d1f7c5543cccc1e4628e7f67cca01f7a8d","market":"0x68f79b97fa41416161cd43b51c95db15b00b56d981daff25e5edb73a9d0312b0","asset_id":"51580329578054957149489759798488692655735024964083433749651796523214592637969","side":"BUY","size":"10","fee_rate_bps":"0","price":"0.63","status":"CONFIRMED","match_time":"1766475074","last_update":"1766475131","outcome":"Up","bucket_index":0,"owner":"ddcdbec0-6736-b2f4-5713-0c1dec277959","maker_address":"0xfdB826A0fB4A90b4CC9049E408ea3Ef1B73Ae4c9","transaction_hash":"0x6cc4dd52787792ff2c9419998f36b27338471fe863e109574a035f5df9c5ef9c","maker_orders":[{"order_id":"0xba1c47e287a6242cd6a1bf34013b52bacc762d2fb2db357eab571ea5e1755289","owner":"a35aea61-d3e2-77b0-ba53-3c4dd029291c","maker_address":"0x795c3aAA5fd42EA3b3543A8F6958F0bC8b4F8171","matched_amount":"10","price":"0.37","fee_rate_bps":"0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","outcome":"Down","side":"BUY"}],"trader_side":"MAKER"},{"id":"48ea4150-703f-447e-a675-65c1245b8993","taker_order_id":"0x00520bf53e914d6bce534885d4ec64ceed65b2da8b1db9b3739d3cc99bb2d623","market":"0x68f79b97fa41416161cd43b51c95db15b00b56d981daff25e5edb73a9d0312b0","asset_id":"51580329578054957149489759798488692655735024964083433749651796523214592637969","side":"BUY","size":"41.838707","fee_rate_bps":"0","price":"0.62","status":"CONFIRMED","match_time":"1766475072","last_update":"1766475131","outcome":"Up","bucket_index":0,"owner":"db18890d-c1a0-19a2-4269-5f2d6cfe2321","maker_address":"0xf444220e8d32f456c39B6B727e7Bb5Bc41D8C970","transaction_hash":"0x6afb16a1ffd7429f08dafd069f053f96487edb369a0c68f7facf033bef61d0fc","maker_orders":[{"order_id":"0x35eda453de3535b188bb536c14db184c86bcbef4a4cf3a2073db97ed4e978548","owner":"a35aea61-d3e2-77b0-ba53-3c4dd029291c","maker_address":"0x795c3aAA5fd42EA3b3543A8F6958F0bC8b4F8171","matched_amount":"10","price":"0.38","fee_rate_bps":"0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","outcome":"Down","side":"BUY"},{"order_id":"0xf97c1a57f99d71d917e9f76b7a8ccac40c9e64e369ea3d70fb99559fe32679ef","owner":"1a98abd0-99ed-173c-e5be-c784f21a9eaa","maker_address":"0x5912794596Cd3CC2F36605710fC1FCd6E5886F45","matched_amount":"31.838707","price":"0.3800000106788256","fee_rate_bps":"0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","outcome":"Down","side":"BUY"}],"trader_side":"MAKER"},{"id":"451b9415-1bb1-45c2-99d4-2e912c902a95","taker_order_id":"0xb425b6953ce99d1ef92090a21f24d21175fc1dac4babcf9ab800cbe4f81c0331","market":"0x68f79b97fa41416161cd43b51c95db15b00b56d981daff25e5edb73a9d0312b0","asset_id":"51580329578054957149489759798488692655735024964083433749651796523214592637969","side":"BUY","size":"10","fee_rate_bps":"0","price":"0.61","status":"CONFIRMED","match_time":"1766475072","last_update":"1766475131","outcome":"Up","bucket_index":0,"owner":"ddcdbec0-6736-b2f4-5713-0c1dec277959","maker_address":"0xfdB826A0fB4A90b4CC9049E408ea3Ef1B73Ae4c9","transaction_hash":"0x5414a22944586077122baff1f6c176b1f7a8409f9c72e1907ff66270440d6f42","maker_orders":[{"order_id":"0xe21d31aafc674cea94f4a4b55d4950bb58abeefeb5c1be9dff8d2ae01db772fe","owner":"a35aea61-d3e2-77b0-ba53-3c4dd029291c","maker_address":"0x795c3aAA5fd42EA3b3543A8F6958F0bC8b4F8171","matched_amount":"10","price":"0.39","fee_rate_bps":"0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","outcome":"Down","side":"BUY"}],"trader_side":"MAKER"},{"id":"230c2f85-0d98-4615-a720-d0130c650b53","taker_order_id":"0xcb583f81f21a82275de4254357e0674da257911fc9706185c099ae5dc5c74f20","market":"0x68f79b97fa41416161cd43b51c95db15b00b56d981daff25e5edb73a9d0312b0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","side":"SELL","size":"1.8","fee_rate_bps":"0","price":"0.39","status":"CONFIRMED","match_time":"1766475067","last_update":"1766475131","outcome":"Down","bucket_index":0,"owner":"ddcdbec0-6736-b2f4-5713-0c1dec277959","maker_address":"0xfdB826A0fB4A90b4CC9049E408ea3Ef1B73Ae4c9","transaction_hash":"0x2bd230740217a4fe243304883c3e7d69bd35fb047da9b8050adfba469dc6a628","maker_orders":[{"order_id":"0xbbb41e726bd337aa02d1e5b9f2e30362f1b8f90a3d1ec56bf44492289dcac2bd","owner":"a35aea61-d3e2-77b0-ba53-3c4dd029291c","maker_address":"0x795c3aAA5fd42EA3b3543A8F6958F0bC8b4F8171","matched_amount":"1.8","price":"0.39","fee_rate_bps":"0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","outcome":"Down","side":"BUY"}],"trader_side":"MAKER"},{"id":"1bc71bc1-4d3b-473f-ac92-87d686aaddb8","taker_order_id":"0xf410fbe202f5b40fd81b5e8238f1a74cdbc82966a9360c440e193e38897a178e","market":"0x68f79b97fa41416161cd43b51c95db15b00b56d981daff25e5edb73a9d0312b0","asset_id":"51580329578054957149489759798488692655735024964083433749651796523214592637969","side":"BUY","size":"8.19672","fee_rate_bps":"0","price":"0.61","status":"CONFIRMED","match_time":"1766475065","last_update":"1766475131","outcome":"Up","bucket_index":0,"owner":"c4010e2a-fcc3-f465-8746-8a5b7f5a5b25","maker_address":"0x316562B603eFa8671040E80714a2C0A5f9eF7e71","transaction_hash":"0x86591cc1e102e8ee0b978c19608b2683e6c4349e38b19fd26c82b26905c616fd","maker_orders":[{"order_id":"0xbbb41e726bd337aa02d1e5b9f2e30362f1b8f90a3d1ec56bf44492289dcac2bd","owner":"a35aea61-d3e2-77b0-ba53-3c4dd029291c","maker_address":"0x795c3aAA5fd42EA3b3543A8F6958F0bC8b4F8171","matched_amount":"8.19672","price":"0.3900000244000039","fee_rate_bps":"0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","outcome":"Down","side":"BUY"}],"trader_side":"MAKER"},{"id":"5e43e33b-2816-4f8a-8aa4-795a942213ce","taker_order_id":"0x819a1c955550dcd2ed699f4c55fc1367e4f56ecba948744cd6cea5048a482646","market":"0x68f79b97fa41416161cd43b51c95db15b00b56d981daff25e5edb73a9d0312b0","asset_id":"51580329578054957149489759798488692655735024964083433749651796523214592637969","side":"BUY","size":"14","fee_rate_bps":"0","price":"0.61","status":"CONFIRMED","match_time":"1766475060","last_update":"1766475131","outcome":"Up","bucket_index":0,"owner":"d266bc1d-771c-3a13-5ae0-9a61f0880e6e","maker_address":"0x6031B6eed1C97e853c6e0F03Ad3ce3529351F96d","transaction_hash":"0x4d4b0641fe8598158c0028b0cb1d57ad9353861ef61fb26d78d69283ed0421fb","maker_orders":[{"order_id":"0xb6e145636cd83d94b31ea097d41156c70dfb239b7fe8680c544ed772f380d72b","owner":"80decb7d-53fa-f1c8-a18b-992ca0f5b8c3","maker_address":"0x593D35B4A344cDcCd23D1fAd7C9BedB6363B04C8","matched_amount":"4","price":"0.39","fee_rate_bps":"0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","outcome":"Down","side":"BUY"},{"order_id":"0x4d2159d6056ed8580701769192f570dbfb1010156a13686dff6ef47c1a74ffad","owner":"a35aea61-d3e2-77b0-ba53-3c4dd029291c","maker_address":"0x795c3aAA5fd42EA3b3543A8F6958F0bC8b4F8171","matched_amount":"10","price":"0.39","fee_rate_bps":"0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","outcome":"Down","side":"BUY"}],"trader_side":"MAKER"},{"id":"01c464af-a0da-4919-ae3a-554d257c057f","taker_order_id":"0x683011b8223b209dbecf039a394ba81527579aa83c446f6f0353a63b2bb5569c","market":"0x68f79b97fa41416161cd43b51c95db15b00b56d981daff25e5edb73a9d0312b0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","side":"BUY","size":"10","fee_rate_bps":"0","price":"0.39","status":"CONFIRMED","match_time":"1766475059","last_update":"1766475131","outcome":"Down","bucket_index":0,"owner":"db18890d-c1a0-19a2-4269-5f2d6cfe2321","maker_address":"0xf444220e8d32f456c39B6B727e7Bb5Bc41D8C970","transaction_hash":"0x9293d7a0dfae6abce33c49bb3e23c4599f763a41a039d98844b900bcbe736d9f","maker_orders":[{"order_id":"0xeace6f59b680bd9e8be9d9c52ad8a3724fae617c13aab70ef7c5ce14f437d97e","owner":"a35aea61-d3e2-77b0-ba53-3c4dd029291c","maker_address":"0x795c3aAA5fd42EA3b3543A8F6958F0bC8b4F8171","matched_amount":"10","price":"0.61","fee_rate_bps":"0","asset_id":"51580329578054957149489759798488692655735024964083433749651796523214592637969","outcome":"Up","side":"BUY"}],"trader_side":"MAKER"},{"id":"1feaa8f8-07dd-435f-be1b-09cf099cc3c1","taker_order_id":"0x41d726d9116bd5f80ecf7961547334ce0b7a5fe72ff1d14a09ddb8c8c3fe36bc","market":"0x68f79b97fa41416161cd43b51c95db15b00b56d981daff25e5edb73a9d0312b0","asset_id":"51580329578054957149489759798488692655735024964083433749651796523214592637969","side":"SELL","size":"16.22","fee_rate_bps":"0","price":"0.59","status":"CONFIRMED","match_time":"1766475059","last_update":"1766475131","outcome":"Up","bucket_index":0,"owner":"577c7739-ca0f-3f3e-85e2-e6df92f6de6b","maker_address":"0xfFFF6537da5Efd428cC09187f90cBD2e726D4413","transaction_hash":"0xb4d49443695f3088eb0ff0254b2980b088db2e8410820d197b6495b68bb2f0bf","maker_orders":[{"order_id":"0xe6ae4213a447bf488456c60756e43bc09c8d19635b5ca2aa42656f311b5bfd00","owner":"f35516e1-5536-63c8-d9fb-b9921350bd73","maker_address":"0x8bEB551D1b187EfE6Cb5d23BA5c5F2eEc521Efd5","matched_amount":"5","price":"0.59","fee_rate_bps":"0","asset_id":"51580329578054957149489759798488692655735024964083433749651796523214592637969","outcome":"Up","side":"BUY"},{"order_id":"0xac9ed91fc874a13edea6ee4a5433c34f3d8ba21552cc258c06832e62823facc6","owner":"cad1ceec-7f5b-8d5e-72d8-4405fc549dc3","maker_address":"0x4A09ee957ba2105a2989a14c584EEce2973dE60A","matched_amount":"5","price":"0.59","fee_rate_bps":"0","asset_id":"51580329578054957149489759798488692655735024964083433749651796523214592637969","outcome":"Up","side":"BUY"},{"order_id":"0xfce1d75627792243ed28584f9852c53f4b84d3d9f628ed93d07e500d3c069d64","owner":"a35aea61-d3e2-77b0-ba53-3c4dd029291c","maker_address":"0x795c3aAA5fd42EA3b3543A8F6958F0bC8b4F8171","matched_amount":"6.22","price":"0.59","fee_rate_bps":"0","asset_id":"51580329578054957149489759798488692655735024964083433749651796523214592637969","outcome":"Up","side":"BUY"}],"trader_side":"MAKER"},{"id":"fdd912f1-ffa5-4dd9-9a5f-932ed8f67ae2","taker_order_id":"0xc1e77381d916159734051da320fbfc60568aa7917eb22ac47626423fb9605073","market":"0x68f79b97fa41416161cd43b51c95db15b00b56d981daff25e5edb73a9d0312b0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","side":"BUY","size":"53","fee_rate_bps":"0","price":"0.4","status":"CONFIRMED","match_time":"1766475059","last_update":"1766475131","outcome":"Down","bucket_index":0,"owner":"db18890d-c1a0-19a2-4269-5f2d6cfe2321","maker_address":"0xf444220e8d32f456c39B6B727e7Bb5Bc41D8C970","transaction_hash":"0x7ad20ef6afd6627d88d73ca68296916c6a00c46a20c051cb3abc960afcd16961","maker_orders":[{"order_id":"0x8b2264324a66407461d013c5c4e19ce55f17d290ae153b73e1355e9f14d998d7","owner":"a6cd9851-a1a4-e1f7-9f3a-cb0251d591bd","maker_address":"0xBE4c1F66B86415Eb17660D3A47d7ff3832A88c82","matched_amount":"25","price":"0.6","fee_rate_bps":"0","asset_id":"51580329578054957149489759798488692655735024964083433749651796523214592637969","outcome":"Up","side":"BUY"},{"order_id":"0xe48a0c4732cee3baa9e2af5a0b6938e83db7a88a5c50ec548284cf3f71808d3b","owner":"aeb293d8-9c6e-0a89-2cd4-28af719c4dda","maker_address":"0x0335267d4a637c9AF70386decBf7E52F04dAcd70","matched_amount":"5","price":"0.6","fee_rate_bps":"0","asset_id":"51580329578054957149489759798488692655735024964083433749651796523214592637969","outcome":"Up","side":"BUY"},{"order_id":"0x05c387266b178f798e812ea85766ed38a7b229d4e5ff609e47098d626ea9008b","owner":"aeb293d8-9c6e-0a89-2cd4-28af719c4dda","maker_address":"0x0335267d4a637c9AF70386decBf7E52F04dAcd70","matched_amount":"5","price":"0.6","fee_rate_bps":"0","asset_id":"51580329578054957149489759798488692655735024964083433749651796523214592637969","outcome":"Up","side":"BUY"},{"order_id":"0x7e1b0b95f774288fc2b903f125960d368a6b3a1e0569f13b211199bc34ade7c5","owner":"a35aea61-d3e2-77b0-ba53-3c4dd029291c","maker_address":"0x795c3aAA5fd42EA3b3543A8F6958F0bC8b4F8171","matched_amount":"10","price":"0.6","fee_rate_bps":"0","asset_id":"51580329578054957149489759798488692655735024964083433749651796523214592637969","outcome":"Up","side":"BUY"},{"order_id":"0xb5fcde7a2cceecfa214388c382c2f9375526b57a4cccb739030ffeb58a6c1e5c","owner":"7a0db442-681d-8f87-d5e4-e97fdbd30a61","maker_address":"0xf178222AF08c15815D9Ee6475924d4cD7a339323","matched_amount":"8","price":"0.6","fee_rate_bps":"0","asset_id":"51580329578054957149489759798488692655735024964083433749651796523214592637969","outcome":"Up","side":"BUY"}],"trader_side":"MAKER"},{"id":"1db5a49e-d56f-4f8b-8646-b248bcc8bd25","taker_order_id":"0x2eff4beba6649f35b69dc99e7db70d1d575bb5a11fc313cf727646940e55b66e","market":"0x68f79b97fa41416161cd43b51c95db15b00b56d981daff25e5edb73a9d0312b0","asset_id":"51580329578054957149489759798488692655735024964083433749651796523214592637969","side":"BUY","size":"3.85","fee_rate_bps":"0","price":"0.6","status":"CONFIRMED","match_time":"1766475059","last_update":"1766475131","outcome":"Up","bucket_index":0,"owner":"a35aea61-d3e2-77b0-ba53-3c4dd029291c","maker_address":"0x795c3aAA5fd42EA3b3543A8F6958F0bC8b4F8171","transaction_hash":"0x81732c99194b539ced24939824e2a9d9f2fe3fe9e5826925cbc15645940ccd4b","maker_orders":[{"order_id":"0xcbc99946417d124c3dcc4ba40595ab60a1f2e18443b9f5550e38246cd38d94b1","owner":"cb7eb21b-8ce6-d196-9a18-c8ad98625d61","maker_address":"0x8Ac1EAed0399f8332f47041436312d6Cd4b19595","matched_amount":"3.85","price":"0.4","fee_rate_bps":"0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","outcome":"Down","side":"BUY"}],"trader_side":"TAKER"},{"id":"5ffd51a8-b609-4d16-9f6a-e7f38a962a46","taker_order_id":"0x6410048001c50b58940255531cb602b3ded793b7f95f8793670cd4c9a85194ff","market":"0x68f79b97fa41416161cd43b51c95db15b00b56d981daff25e5edb73a9d0312b0","asset_id":"7173864744462347047335064792775570731406723196922368846527716389441715673898","side":"BUY","size":"10","fee_rate_bps":"0","price":"0.38","status":"CONFIRMED","match_time":"1766475057","last_update":"1766475131","outcome":"Down","bucket_index":0,"owner":"94adb302-e45f-491a-7cc2-3958e8cbf4b8","maker_address":"0x4F84832c7aAa9359A2d8488A7227bda4eB481f15","transaction_hash":"0xa3a16721fcbe8061f09087497e6673a28d4067fa13acc839c4ce6b6023e2dc2b","maker_orders":[{"order_id":"0x7e492c303a696899d37b7f677287b4f8f0443bab61508d233103fa25a88e21b9","owner":"a35aea61-d3e2-77b0-ba53-3c4dd029291c","maker_address":"0x795c3aAA5fd42EA3b3543A8F6958F0bC8b4F8171","matched_amount":"10","price":"0.62","fee_rate_bps":"0","asset_id":"51580329578054957149489759798488692655735024964083433749651796523214592637969","outcome":"Up","side":"BUY"}],"trader_side":"MAKER"}],"next_cursor":"LTE=","limit":300,"count":19}
*/
func applyTradesToInventory(data []polymarket.Trade, funder string) {
	for _, trade := range data {
		applyTradeForInventory(
			trade.AssetID,
			trade.Market,
			trade.Side,
			trade.TraderSide,
			trade.MakerAddress,
			trade.Price,
			trade.Size,
			trade.MakerOrders,
			funder,
			"inventory init",
		)
	}
}

func applyTradeForInventory(assetID string, marketID string, side string, traderSide string, makerAddress string, price any, size any, orders []polymarket.MakerOrder, normalizedFunder string, logPrefix string) []string {
	updated := make([]string, 0, len(orders)+1)

	if traderSide == "TAKER" && makerAddress == normalizedFunder && side == string(polymarket.SideBuy) {
		priceVal, okPrice := parseFloat(price)
		sizeVal, okSize := parseFloat(size)

		if okPrice && okSize {
			applyBuyFill(assetID, marketID, sizeVal, priceVal, logPrefix)
			updated = append(updated, assetID)
		}
	}

	updated = append(updated, applyMakerOrders(marketID, orders, normalizedFunder, logPrefix)...)
	return updated
}

func applyMakerOrders(marketID string, orders []polymarket.MakerOrder, normalizedFunder string, logPrefix string) []string {
	updated := make([]string, 0, len(orders))

	for _, order := range orders {
		if order.MakerAddress != normalizedFunder {
			continue
		}

		assetID := order.AssetID
		priceVal, okPrice := parseFloat(order.Price)
		sizeVal, okSize := parseFloat(order.MatchedAmount)
		if !okPrice || !okSize {
			continue
		}
		side := order.Side

		if side != string(polymarket.SideBuy) {
			continue
		}

		applyBuyFill(assetID, marketID, sizeVal, priceVal, logPrefix)

		updated = append(updated, assetID)
	}

	return updated
}

func applyBuyFill(assetID string, marketID string, sizeVal float64, priceVal float64, logPrefix string) {
	qtyBefore, avgBefore, costBefore := GetAssetPosition(assetID)
	AddAsset(assetID, marketID, sizeVal, priceVal)
	qtyAfter, avgAfter, costAfter := GetAssetPosition(assetID)
	log.Printf(
		"%s: asset=%s market=%s size=%.4f qty=%.4f->%.4f avg=%.4f->%.4f cost=%.4f->%.4f",
		logPrefix,
		assetID,
		marketID,
		sizeVal,
		qtyBefore,
		qtyAfter,
		avgBefore,
		avgAfter,
		costBefore,
		costAfter,
	)
}
